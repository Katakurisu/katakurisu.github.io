<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Overlay حمایت - صف پرداخت ها + آمار زنده</title>
<style>
/* ____________________ 🎬 استایل Overlay 🎬 ____________________ */
body {
  margin:0;
  font-family:'Vazirmatn',sans-serif;
  background:transparent;
  color:#00ff99;
  text-align:center;
  direction:rtl;
  overflow:hidden;
}

/* -------------------- پنل زنده جمع کل و درصد هدف -------------------- */
#stats {
  position:fixed;
  bottom:10px;
  left:10px;
  font-size:1.2em;
  background:rgba(0,0,0,0.7);
  border-radius:12px;
  padding:15px 20px;
  color:#00ff99;
  text-shadow:0 0 12px #00ff99;
  z-index:5;
}

/* -------------------- Overlay هشدار پرداخت -------------------- */
#overlay {
  position:fixed;
  inset:0;
  pointer-events:none;
}
#donation-alert {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  text-align:center;
  background:rgba(0,0,0,0.7);
  border:2px solid #00ff99;
  border-radius:20px;
  padding:20px 30px;
  display:none;
  z-index:10;
}
#donation-video {
  width:180px;
  height:180px;
  border-radius:12px;
  margin-bottom:15px;
}
#donor-text {
  font-size:1.3em;
  text-shadow:0 0 12px #00ff99;
  opacity:0;
  transition: opacity 0.7s ease-in-out;
}

@media(max-width:500px){
  #donation-video{width:140px;height:140px;}
  #donor-text{font-size:1.1em;}
  #stats{font-size:1em;padding:10px 15px;}
}
</style>
</head>
<body>

<!-- ____________________ 🎬 Overlay هشدار پرداخت 🎬 ____________________ -->
<div id="overlay">
  <div id="donation-alert">
    <video id="donation-video" src="alert-donate.mp4" autoplay muted></video>
    <p id="donor-text"></p>
  </div>
</div>

<!-- ____________________ 📊 پنل جمع کل و درصد هدف 📊 ____________________ -->
<div id="stats">
  <p>💰 جمع کل: <span id="total">0</span> ریال</p>
  <p>🎯 درصد هدف: <span id="percent">0</span>%</p>
</div>

<script>
/* ____________________ 🎬 المان های DOM 🎬 ____________________ */
const alertBox = document.getElementById('donation-alert');
const donorText = document.getElementById('donor-text');
const videoEl = document.getElementById('donation-video');
const totalEl = document.getElementById('total');
const percentEl = document.getElementById('percent');

/* ____________________ 🟢 صف پرداخت ها 🟢 ____________________ */
let donationQueue = [];
let isShowing = false;

/* ____________________ 🎯 تنظیمات هدف و جمع کل 🎯 ____________________ */
let total = 0;
const target = 60000000;

/* ____________________ 🌐 اتصال به وبهوک دریافت پرداخت ها 🌐 ____________________ */
async function fetchDonations(){
  try{
    const res = await fetch('https://eoyf8grpms15wjd.m.pipedream.net',{cache:'no-store'});
    const data = await res.json();
    data.forEach(d => {
      if(!d.handled){
        d.handled = true;
        donationQueue.push(d); // اضافه کردن به صف
        total += (d.amount*d.currency_rate || d.amount || 0); // اضافه کردن به جمع کل
        updateStats();
        showNextDonation();
      }
    });
  } catch(e){console.warn(e);}
}
setInterval(fetchDonations, 5000);

/* ____________________ 🔢 آپدیت جمع کل و درصد هدف 🔢 ____________________ */
function updateStats(){
  totalEl.textContent = total.toLocaleString('fa-IR');
  percentEl.textContent = Math.min(((total/target)*100).toFixed(1),100);
}

/* ____________________ 🎬 نمایش پرداخت ها از صف 🎬 ____________________ */
function showNextDonation(){
  if(isShowing || donationQueue.length === 0) return;
  const d = donationQueue.shift();
  isShowing = true;
  
  const amountIRR = d.amount*d.currency_rate || d.amount || 0;
  donorText.textContent = (d.name||'حامی ناشناس') + ' | ' + amountIRR.toLocaleString('fa-IR') + ' ریال' + (d.message?(' | '+d.message):'');
  
  alertBox.style.display='block';
  videoEl.currentTime=0;
  videoEl.play();
  
  donorText.style.opacity = 0;
  setTimeout(()=>{donorText.style.opacity = 1;}, 50);
  
  setTimeout(()=>{
    donorText.style.opacity = 0;
    setTimeout(()=>{
      alertBox.style.display='none';
      isShowing = false;
      showNextDonation(); // نمایش بعدی از صف
    }, 700);
  },13000);
}
</script>

</body>
</html>
