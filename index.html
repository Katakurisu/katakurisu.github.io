<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Katakuri — دونیت برای کیک</title>

<!-- پایه CSP برای محدود کردن منابع -->
<meta http-equiv="Content-Security-Policy" content="
  default-src 'self';
  script-src 'self' https://www.gstatic.com https://*.googleapis.com;
  connect-src 'self' https://katakuri-43539-default-rtdb.firebaseio.com https://*.googleapis.com;
  img-src 'self' data:;
  style-src 'self' 'unsafe-inline' https://fonts.googleapis.com;
  font-src https://fonts.gstatic.com;
  frame-ancestors 'none';
">

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f12;--surface:#0f1416;--text:#e6f3f0;--accent:#39d9b1;--radius:12px}
body{margin:0;font-family:'Vazirmatn',system-ui;background:var(--bg);color:var(--text);padding:20px}
.container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 360px;gap:18px}
.card{background:var(--surface);padding:16px;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,0.5)}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.logo{font-weight:700;color:var(--accent);font-size:20px}
.stats{display:flex;gap:10px}
.stat{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;text-align:center;min-width:110px}
.donations{display:flex;flex-direction:column;gap:8px;max-height:65vh;overflow:auto;padding:8px;background:rgba(255,255,255,0.01);border-radius:8px}
.donation{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
.small{font-size:13px;color:var(--text)}
.btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer;background:var(--accent);color:#071213}
.note{font-size:13px;color:#cdd;line-height:1.4;margin-top:8px}
#notif{display:none;padding:10px;background:var(--accent);color:#071213;border-radius:8px;margin-top:10px;white-space:pre-wrap}
footer{margin-top:18px;color:#9aa3a6;font-size:13px;text-align:center}
</style>
</head>
<body>
<div class="container">
  <main>
    <div class="card">
      <div class="header"><div class="logo">Katakuri</div><div id="clock" class="small"></div></div>
      <h3>هدف: جمع‌آوری برای کیک</h3>
      <div class="stats" style="margin-top:8px">
        <div class="stat"><div class="small">مجموع</div><div id="total" style="font-weight:700;margin-top:6px">۰ تومان</div></div>
        <div class="stat"><div class="small">تعداد دونیت</div><div id="count" style="font-weight:700;margin-top:6px">۰</div></div>
      </div>

      <div style="margin-top:12px">
        <button class="btn" onclick="alert('برای دونیت از درگاه امن استفاده کنید')">دونیت واقعی</button>
        <button class="btn" style="background:#2b3" onclick="alert('تست دونیت غیرفعال است')">تست</button>
      </div>

      <p class="note">
        برای حفظ حریم خصوصی: هر فیلدی که شما \"مخفی\" تعریف کنید **هرگز** به این صفحه ارسال نمی‌شود.
        اگر اهداکننده پیامش را عمومی کند، آن پیام در صفحه نمایش داده می‌شود؛ در غیر این صورت فقط summary عمومی نشان داده می‌شود.
      </p>

      <div id="notif" role="status" aria-live="polite"></div>
    </div>
  </main>

  <aside>
    <div class="card">
      <h4 style="margin:0 0 8px 0">آخرین دونیت‌ها</h4>
      <div class="donations" id="donationList" aria-live="polite"></div>
      <footer>فقط فیلدهای عمومی (who, amount, time و در صورت انتخاب پیام عمومی) نمایش داده می‌شود.</footer>
    </div>
  </aside>
</div>

<script type="module">
/* --- توضیح کوتاهِ طرح داده‌ها (schema) ---
 publicDonations/{id} = { who, amount, time, messagePublic?: true, message?: "..." (only if messagePublic === true) }
 privateDonations/{id} = { who, amount, time, phone?, message? (raw) , anyOtherPrivateFields... }
  - Frontend only reads publicDonations.
  - Writing to privateDonations must be done server-side (Admin SDK) or manually in Console.
*/

/* Firebase client (public config OK) */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-app.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.16.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDoa301J7GQSH7S9-rdax4AgxkYV_67Gd4",
  authDomain: "katakuri-43539.firebaseapp.com",
  databaseURL: "https://katakuri-43539-default-rtdb.firebaseio.com/",
  projectId: "katakuri-43539",
  storageBucket: "katakuri-43539.appspot.com",
  messagingSenderId: "813013688047",
  appId: "1:813013688047:web:fdecdb1961685db40b451a"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

function fmt(n){ try{ return new Intl.NumberFormat('fa-IR').format(n)+' تومان'; }catch(e){ return n+' تومان'; } }
function pad(n){ return n<10 ? '0'+n : n; }

/* escape to prevent XSS from public fields */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]); });
}

/* load only publicDonations */
async function loadPublicDonations(){
  try{
    const snap = await get(ref(db, 'publicDonations'));
    const entries = snap.val() ? Object.entries(snap.val()) : [];
    // sort by time desc
    entries.sort((a,b)=> (b[1].time||0) - (a[1].time||0));
    const list = entries.map(([id,obj]) => ({ id, ...obj }));
    document.getElementById('total').textContent = fmt(list.reduce((s,d)=>s+(d.amount||0),0));
    document.getElementById('count').textContent = list.length;
    const container = document.getElementById('donationList');
    container.innerHTML = '';
    const top = Math.min(50, list.length);
    for(let i=0;i<top;i++){
      const d = list[i];
      const date = new Date(d.time||Date.now());
      const dateStr = date.getFullYear() + '/' + pad(date.getMonth()+1) + '/' + pad(date.getDate()) + ' ' + pad(date.getHours()) + ':' + pad(date.getMinutes());
      const who = d.who ? (d.who.length>30 ? d.who.substr(0,30)+'…' : d.who) : 'حامی ناشناس';
      const el = document.createElement('div');
      el.className = 'donation';
      // If messagePublic is true and message exists, show it; otherwise show contact-admin note
      const messageHtml = (d.messagePublic && d.message) ? ('<div style="font-size:13px;color:#cde;margin-top:6px">'+escapeHtml(d.message)+'</div>') : '';
      const detailsBtn = (d.messagePublic && d.message) ? '' : '<div style="width:90px;text-align:center"><button class="btn" onclick="notifyAdmin()">جزئیات</button></div>';
      el.innerHTML = '<div style="flex:1"><div style="font-weight:600">'+escapeHtml(who)+'</div><div class="small">'+escapeHtml(dateStr)+'</div>'+messageHtml+'</div>'
                   + '<div style="min-width:110px;text-align:right;font-weight:700">'+fmt(d.amount||0) +'</div>'
                   + detailsBtn;
      container.appendChild(el);
    }
  }catch(e){
    console.error(e);
    const n = document.getElementById('notif');
    n.style.display='block'; n.textContent='خطا در بارگذاری دونیت‌ها';
    setTimeout(()=>{ n.style.display='none'; },4000);
  }
}

window.notifyAdmin = function(){
  const n = document.getElementById('notif');
  n.style.display = 'block';
  n.textContent = 'برای دیدن اطلاعات مخفی (شماره/پیام خصوصی) لطفاً با مدیر تماس بگیرید — جزئیات فقط در کنسول ادمین یا سیستم سرور قابل‌دسترس است.';
  setTimeout(()=>{ n.style.display='none'; },6000);
}

/* clock */
function updateClock(){
  const now = new Date();
  const s = now.getFullYear() + '/' + pad(now.getMonth()+1) + '/' + pad(now.getDate()) + ' ' + pad(now.getHours()) + ':' + pad(now.getMinutes()) + ':' + pad(now.getSeconds());
  document.getElementById('clock').textContent = s;
  requestAnimationFrame(updateClock);
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  loadPublicDonations();
  updateClock();
});
</script>
</body>
</html>
